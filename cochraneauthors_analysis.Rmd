---
title: "A meta-research on the Cochrane Reviews' authors"
author: "Ahmad Sofi-Mahmudi"
date: "`r Sys.Date()`"
output: html_document
---

# Loading required packages

```{r}
pacman::p_load(dplyr,
               here,
               knitr,
               ggplot2,
               tidyr,
               maps,
               stringr,
               rnaturalearth)
```


# Loading the dataset
```{r}
db = read.csv(here("data", "cochraneauthors_db.csv"), 
               header = TRUE,
               na.strings = c("", "NA"))
```

# Overall perspective

Total number of papers:
```{r}
nrow(db)
```

Number of papers that their authors affiliations were retrieved from Cochrane Library successfully:
```{r}
nrow(db)
```

# Country and region diversity

## First authors
### Countries

The number of countries detected successfully:
```{r}
sum(table(db$first_author_country))
```

Top ten countries with the highest number of first authors:
```{r}
top_first <- table(db$first_author_country) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_first) <- c("country", "frequency")

kable(top_first[1:10,])
```

Map
```{r}
# Loading the world map
world_map <- map_data("world")
world_map <- subset(world_map, region != "Antarctica")

# Some modifications are needed
top_first$country <- as.character(top_first$country)
top_first$country[top_first$country == "United States"] <- "USA"
top_first$country[top_first$country == "United Kingdom"] <- "UK"
top_first$country <- as.factor(top_first$country)

# Drawing the map
ggplot(top_first) +
  geom_map(
    dat = world_map, map = world_map, aes(map_id = region),
    fill = "white", color = "#7f7f7f", size = 0.25
  ) +
  geom_map(map = world_map, aes(map_id = country, fill = frequency), size = 0.25) +
  scale_fill_gradient(low = "#fff7bc", high = "#cc4c02", name = "Total First Authors") +
  expand_limits(x = world_map$long, y = world_map$lat) + theme(legend.position="bottom",
        axis.line=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid=element_blank())
```


### United Nations regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$first_author_region_un))
```

Top regions with the highest number of first authors:
```{r}
top_un_first <- table(db$first_author_region_un) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_un_first) <- c("un region", "frequency")

kable(top_un_first)
```

### World Bank regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$first_author_region_wb))
```

Top regions with the highest number of first authors:
```{r}
top_wb_first <- table(db$first_author_region_wb) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_wb_first) <- c("wb region", "frequency")

kable(top_wb_first)
```
### Income-level regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$first_author_region_income))
```

Top regions with the highest number of first authors:
```{r}
top_income_first <- table(db$first_author_region_income) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_income_first) <- c("income region", "frequency")

kable(top_income_first)
```

## Last authors
### Countries

The number of countries detected successfully:
```{r}
sum(table(db$last_author_country))
```

Top ten countries with the highest number of first authors:
```{r}
top_last <- table(db$last_author_country) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_last) <- c("country", "frequency")

kable(top_last[1:10,])
```

Map
```{r}
# Loading the world map
world_map <- map_data("world")
world_map <- subset(world_map, region != "Antarctica")

# Some modifications are needed
top_last$country <- as.character(top_last$country)
top_last$country[top_last$country == "United States"] <- "USA"
top_last$country[top_last$country == "United Kingdom"] <- "UK"
top_last$country <- as.factor(top_last$country)

# Drawing the map
ggplot(top_last) +
  geom_map(
    dat = world_map, map = world_map, aes(map_id = region),
    fill = "white", color = "#7f7f7f", size = 0.25
  ) +
  geom_map(map = world_map, aes(map_id = country, fill = frequency), size = 0.25) +
  scale_fill_gradient(low = "#fff7bc", high = "#cc4c02", name = "Total Last Authors") +
  expand_limits(x = world_map$long, y = world_map$lat) + theme(legend.position="bottom",
        axis.line=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid=element_blank())
```


### United Nations regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$last_author_region_un))
```

Top regions with the highest number of first authors:
```{r}
top_un_last <- table(db$last_author_region_un) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_un_last) <- c("un region", "frequency")

kable(top_un_last)
```

### World Bank regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$last_author_region_wb))
```

Top regions with the highest number of first authors:
```{r}
top_wb_last <- table(db$last_author_region_wb) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_wb_last) <- c("wb region", "frequency")

kable(top_wb_last)
```
### Income-level regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$last_author_region_income))
```

Top regions with the highest number of first authors:
```{r}
top_income_last <- table(db$last_author_region_income) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_income_last) <- c("income region", "frequency")

kable(top_income_last)

```

## Corresponding authors
### Countries

The number of countries detected successfully:
```{r}
sum(table(db$corresponding_author_country))
```

Top ten countries with the highest number of first authors:
```{r}
top_corresponding <- table(db$corresponding_author_country) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_corresponding) <- c("country", "frequency")

kable(top_corresponding[1:10,])
```

Map
```{r}
# Loading the world map
world_map <- map_data("world")
world_map <- subset(world_map, region != "Antarctica")

# Some modifications are needed
top_corresponding$country <- as.character(top_corresponding$country)
top_corresponding$country[top_corresponding$country == "United States"] <- "USA"
top_corresponding$country[top_corresponding$country == "United Kingdom"] <- "UK"
top_corresponding$country <- as.factor(top_corresponding$country)

# Drawing the map
ggplot(top_corresponding) +
  geom_map(
    dat = world_map, map = world_map, aes(map_id = region),
    fill = "white", color = "#7f7f7f", size = 0.25
  ) +
  geom_map(map = world_map, aes(map_id = country, fill = frequency), size = 0.25) +
  scale_fill_gradient(low = "#fff7bc", high = "#cc4c02", name = "Total Last Authors") +
  expand_limits(x = world_map$long, y = world_map$lat) + theme(legend.position="bottom",
        axis.line=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid=element_blank())
```


### United Nations regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$corresponding_author_region_un))
```

Top regions with the highest number of first authors:
```{r}
top_un_corresponding <- table(db$corresponding_author_region_un) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_un_corresponding) <- c("un region", "frequency")

kable(top_un_corresponding)
```

### World Bank regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$corresponding_author_region_wb))
```

Top regions with the highest number of first authors:
```{r}
top_wb_corresponding <- table(db$corresponding_author_region_wb) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_wb_corresponding) <- c("wb region", "frequency")

kable(top_wb_corresponding)
```
### Income-level regions
The number of countries that their region detected successfully:
```{r}
sum(table(db$corresponding_author_region_income))
```

Top regions with the highest number of first authors:
```{r}
top_income_corresponding <- table(db$corresponding_author_region_income) %>% 
  as.data.frame() %>%
  arrange(desc(Freq))

colnames(top_income_corresponding) <- c("income region", "frequency")

kable(top_income_corresponding)

```


# Trends for region diversity
## Europe vs. non-Europe (Based on the UN regions)
First, making new columns for Europe vs. non-Europe
```{r}
db <- db %>% mutate(first_author_europe = ifelse(first_author_region_un == "Europe", TRUE, FALSE),
                    corresponding_author_europe = ifelse(corresponding_author_region_un == "Europe", TRUE, FALSE),
                    last_author_europe = ifelse(last_author_region_un == "Europe", TRUE, FALSE))
```

Then, making a line graph for all three indicators:
```{r}

yearly_trend_region_europe <- 
        db %>% 
        select(year,
               first_author_europe,
               corresponding_author_europe,
               last_author_europe) %>%
        gather("indicator", "value", -year) %>%
        count(year, indicator, value) %>%
        mutate(indicator = recode(indicator,
                                  first_author_europe = "First authors from European countries",
                                  corresponding_author_europe = "Corresponding authors from European countries",
                                  last_author_europe = "Last authors from European countries")) %>%
        complete(indicator, value, year, fill = list(n = 0)) %>%
        group_by(year, indicator) %>% 
        mutate(p = n / sum(n)) %>%
        filter(value) %>%
        ungroup()

plot_trend_region_europe <-
        yearly_trend_region_europe %>% 
        ggplot() +
        aes(x = year, 
            y = p,
            group = indicator,
            color = indicator) +
        geom_line(size = 0.75) +
        scale_y_continuous(limits = c(0, 1), 
                           labels = scales::percent) +
        scale_color_discrete(name = NULL) +
        scale_fill_discrete(breaks = c("First authors from European countries",
                                       "Corresponding authors from European countries",
                                       "Last authors from European countries")) +
        labs(   title="Region diversity in Cochrane Reviews' authorship: Europe vs. non-Europe",
                y = "Proportion of authors from European countries (%)", 
                x = "Year") +
        theme(panel.grid.minor = element_blank(),
              legend.position = c(0.2, 0.90),
              axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)
              )
#png("figures/fig_region-diversity_europe.png", width = 10, height = 7, units = "in", res = 800)
plot_trend_region_europe
#dev.off()
```


## High income: OECD vs. non-High income: OECD (based on the WB income regions)
First, making new columns for High income: OECD vs. non-High income: OECD
```{r}
db <- db %>% mutate(first_author_highincome = ifelse(first_author_region_income == "1. High income: OECD", TRUE, FALSE),
                    corresponding_author_highincome = ifelse(corresponding_author_region_income == "1. High income: OECD", TRUE, FALSE),
                    last_author_highincome = ifelse(last_author_region_income == "1. High income: OECD", TRUE, FALSE))
```

Then, making a line graph for all three indicators:
```{r}

yearly_trend_region_highincome <- 
        db %>% 
        select(year,
               first_author_highincome,
               corresponding_author_highincome,
               last_author_highincome) %>%
        gather("indicator", "value", -year) %>%
        count(year, indicator, value) %>%
        mutate(indicator = recode(indicator,
                                  first_author_highincome = "First authors from High-income OECD countries",
                                  corresponding_author_highincome = "Corresponding authors from High-income OECD countries",
                                  last_author_highincome = "Last authors from High-income OECD countries")) %>%
        complete(indicator, value, year, fill = list(n = 0)) %>%
        group_by(year, indicator) %>% 
        mutate(p = n / sum(n)) %>%
        filter(value) %>%
        ungroup()

plot_trend_region_highincome <-
        yearly_trend_region_highincome %>% 
        ggplot() +
        aes(x = year, 
            y = p,
            group = indicator,
            color = indicator) +
        geom_line(size = 0.75) +
        scale_y_continuous(limits = c(0, 1), 
                           labels = scales::percent) +
        scale_color_discrete(name = NULL) +
        scale_fill_discrete(breaks = c("First authors from High-income OECD countries",
                                       "Corresponding authors from High-income OECD countries",
                                       "Last authors from High-income OECD countries")) +
        labs(   title="Region diversity in Cochrane Reviews' authorship: High-income OECD vs. non-High-income OECD",
                y = "Proportion of authors from High-income OECD countries (%)", 
                x = "Year") +
        theme(panel.grid.minor = element_blank(),
              legend.position = c(0.2, 0.40),
              axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)
              )
#png("figures/plot_trend_region_highincome.png", width = 10, height = 7, units = "in", res = 800)
plot_trend_region_highincome
#dev.off()
```

## English-speaking diversity
We have the column. So, we directly make a line graph for all three indicators:
```{r}

yearly_trend_region_english <- 
        db %>% 
        select(year,
               first_author_english,
               corresponding_author_english,
               last_author_english) %>%
        gather("indicator", "value", -year) %>%
        count(year, indicator, value) %>%
        mutate(indicator = recode(indicator,
                                  first_author_english = "First authors from English-speaking countries",
                                  corresponding_author_english = "Corresponding authors from English-speaking countries",
                                  last_author_english = "Last authors from English-speaking countries")) %>%
        complete(indicator, value, year, fill = list(n = 0)) %>%
        group_by(year, indicator) %>% 
        mutate(p = n / sum(n)) %>%
        filter(value == "Yes") %>%
        ungroup()

plot_trend_region_english <-
        yearly_trend_region_english %>% 
        ggplot() +
        aes(x = year, 
            y = p,
            group = indicator,
            color = indicator) +
        geom_line(size = 0.75) +
        scale_y_continuous(limits = c(0, 1), 
                           labels = scales::percent) +
        scale_color_discrete(name = NULL) +
        scale_fill_discrete(breaks = c("First authors from English-speaking countries",
                                       "Corresponding authors from English-speaking countries",
                                       "Last authors from English-speaking countries")) +
        labs(   title="Region diversity in Cochrane Reviews' authorship: English-speaking vs. non-English-speaking",
                y = "Proportion of authors from English-speaking countries (%)", 
                x = "Year") +
        theme(panel.grid.minor = element_blank(),
              legend.position = c(0.2, 0.40),
              axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)
              )
#png("figures/plot_trend_region_english.png", width = 10, height = 7, units = "in", res = 800)
plot_trend_region_english
#dev.off()
```


## SCImago country rank trend
To investigate whether Cochrane diversity in English-speaking section is because of organizational measurements or not, we can compare it with global trend. SCImago has the number of papers for each country since 1996. We use 1996, 2000, 2005, 2010, 2015, and 2021 for making our desired trend.

First, loading all xlsx files:
```{r}
library(openxlsx)

sci1996 <- read.xlsx("data/scimago/scimagojr country rank 1996.xlsx")
sci2000 <- read.xlsx("data/scimago/scimagojr country rank 2000.xlsx")
sci2005 <- read.xlsx("data/scimago/scimagojr country rank 2005.xlsx")
sci2010 <- read.xlsx("data/scimago/scimagojr country rank 2010.xlsx")
sci2015 <- read.xlsx("data/scimago/scimagojr country rank 2015.xlsx")
sci2021 <- read.xlsx("data/scimago/scimagojr country rank 2021.xlsx")

```

Then, we add a column for it:
```{r}

sci1996$english <- sapply(
  sci1996$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })

sci2000$english <- sapply(
  sci2000$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })

sci2005$english <- sapply(
  sci2005$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })

sci2010$english <- sapply(
  sci2010$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })

sci2015$english <- sapply(
  sci2015$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })

sci2021$english <- sapply(
  sci2021$Country,
  function(x) if (str_extract_all(x, 
                                  english_speaking) == "character(0)"){
                                    FALSE
                                  } else {
                                    TRUE
                                  })
```

Making a new dataframe that has aggregated data:
```{r}

aggregate(Documents ~ english, data = sci1996, sum) %>% mutate(p = Documents / sum(Documents), year = 1996) %>% filter(english) %>% ungroup()

scimago_trend <- rbind(aggregate(Documents ~ english, data = sci1996, sum) %>% mutate(p = Documents / sum(Documents), year = 1996) %>% filter(english) %>% ungroup(),
                       aggregate(Documents ~ english, data = sci2000, sum) %>% mutate(p = Documents / sum(Documents), year = 2000) %>% filter(english) %>% ungroup(),
                       aggregate(Documents ~ english, data = sci2005, sum) %>% mutate(p = Documents / sum(Documents), year = 2005) %>% filter(english) %>% ungroup(),
                       aggregate(Documents ~ english, data = sci2010, sum) %>% mutate(p = Documents / sum(Documents), year = 2010) %>% filter(english) %>% ungroup(),
                       aggregate(Documents ~ english, data = sci2015, sum) %>% mutate(p = Documents / sum(Documents), year = 2015) %>% filter(english) %>% ungroup(),
                       aggregate(Documents ~ english, data = sci2021, sum) %>% mutate(p = Documents / sum(Documents), year = 2021) %>% filter(english) %>% ungroup())

```


Now making the SCImago trend
```{r}

plot_trend_scimago_english <-
        scimago_trend %>% 
        ggplot() +
        aes(x = year, 
            y = p) +
        geom_line(size = 0.75) +
        scale_y_continuous(limits = c(0, 1), 
                           labels = scales::percent) +
        scale_color_discrete(name = NULL) +
        scale_fill_discrete(breaks = "Documents from English-speaking countries") +
        labs(   title="Region diversity in authorship of scientific documents (SCImago): English-speaking vs. non-English-speaking",
                y = "Proportion of authors from English-speaking countries (%)", 
                x = "Year") +
        theme(panel.grid.minor = element_blank(),
              legend.position = c(0.2, 0.40),
              axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)
              )
#png("figures/plot_trend_scimago_english.png", width = 10, height = 7, units = "in", res = 800)
plot_trend_scimago_english
#dev.off()
```

# Gender diversity

### Trend
```{r}

yearly_trend_gender <- db %>%
  select(year, country_1stauthor_gender) %>%
  group_by(year) %>%
  summarise(MtoF = sum(country_1stauthor_gender == "M")/sum(country_1stauthor_gender == "F"))


pg1 <-
        yearly_trend_gender %>% 
        ggplot() +
        aes(x = year, 
            y = MtoF) +
        geom_line(size = 0.75) +
        scale_color_discrete(name = NULL) +
        labs(   title="Male to female ratio for each year",
                y = "Ratio", 
                x = "Year") +
        theme(panel.grid.minor = element_blank(),
              legend.position = c(0.13, 0.87),
              axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)
              )
pg1
```

